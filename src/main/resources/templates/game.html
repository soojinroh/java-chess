<!doctype html>
<html lang="kor">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/chessboard-1.0.0.css">
    <title>Hello, world!</title>
</head>

<body>
    <div class="container">
        <div id="board1" style="width: 400px"></div>
        <button id="status" onclick="processStatus()">Status</button>
        <p id="msg"></p>

    </div>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <script src="/js/chessboard-1.0.0.js"></script>
    <script>
        var board1;
        initialize();

        // snapback black pieces when they are dropped
        function onDrop(source, target, piece, newPos, oldPos, orientation) {
            var result = "";
        
            $.ajax({
                type: 'POST',
                url: '/game/{{gameId}}',
                data: {
                    "source" : source,
                    "target" : target
                },
                async: false,
                success: function(data) {
                    let msg = document.getElementById("msg");
                    if(data === "CONTINUE") {
                        msg.innerHTML = "";
                        return;
                     } else if (data === "BLACK_WIN") {
                        alert("흑색이 이겼습니다.");
                        history.back();
                     } else if (data === "WHITE_WIN") {
                        alert("백색이 이겼습니다.");
                        history.back();
                     } else {
                        result = "snapback";
                        msg.innerHTML = data; 
                    }
                }
           });
 
           console.log(typeof(result));
           console.log(result);
           return result;
        }

        function initialize() {
            console.log("Initializing...");
            // ajax call, 서버에서 보드 상황을 가져옴.
            fetch("/board/{{gameId}}")
                .then(res => res.json())
                .then(json => {
                    console.log(json);
                    board1 = Chessboard('board1', {
                        draggable: true,
                        dropOffBoard: 'snapback',
                        position: json,
                        onDrop: onDrop
                    })

                    $('#startBtn').on('click', board1.start)
                    $('#clearBtn').on('click', board1.clear)
                });
        }

        function processStatus() {
            // ajax call, 서버에서 게임을 중단하고 점수 계산, 승자 판별
            fetch("/score/{{gameId}}")
                .then(res => res.json())
                .then(data => {
                    var msg = "";
                    if (data.result === "BLACK_WIN") {
                        msg += "흑색이 이겼습니다.";
                    } else if (data.result === "WHITE_WIN") {
                        msg += "백색이 이겼습니다.";
                    } else {
                        msg += "비겼습니다.";
                    }
                    msg += "  흑: " + data.blackScore + " 백: " + data.whiteScore;
                    alert(msg);
                    history.back();
                });
            }
        
    </script>
</body>

</html>